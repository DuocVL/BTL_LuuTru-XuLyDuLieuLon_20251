<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentiment Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        button {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 7px 20px rgba(0,0,0,0.3);
        }
        
        button.active {
            background: #667eea;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }
        
        .stat-detail {
            color: #666;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .chart-title {
            color: #667eea;
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        
        .predictions-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .prediction-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }
        
        .prediction-item:hover {
            background: #f5f5f5;
        }
        
        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .model-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .sentiment-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .positive {
            background: #4caf50;
            color: white;
        }
        
        .negative {
            background: #f44336;
            color: white;
        }
        
        .correct {
            color: #4caf50;
        }
        
        .incorrect {
            color: #f44336;
        }
        
        .loading {
            text-align: center;
            color: white;
            font-size: 1.2em;
            margin: 50px 0;
        }
        
        .error {
            background: #f44336;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .timestamp {
            color: #999;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Real-time Sentiment Analysis Dashboard</h1>
        
        <div class="controls">
            <button onclick="loadDashboard()">üîÑ Refresh Data</button>
            <button onclick="toggleAutoRefresh()">‚è±Ô∏è Auto-Refresh: <span id="autoRefreshStatus">ON</span></button>
            <button onclick="switchSource('all')" id="btnAll" class="active">üìä All Sources</button>
            <button onclick="switchSource('spark')" id="btnSpark">‚ö° Spark Only</button>
            <button onclick="switchSource('hadoop')" id="btnHadoop">üêò Hadoop Only</button>
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div class="stats-grid" id="statsGrid">
            <div class="loading">Loading statistics...</div>
        </div>
        
        <div class="chart-container">
            <h2 class="chart-title">üìä Model Performance Comparison</h2>
            <canvas id="modelComparisonChart"></canvas>
        </div>
        
        <div class="chart-container">
            <h2 class="chart-title">üìà Sentiment Trend (Last 24 Hours)</h2>
            <canvas id="sentimentTrendChart"></canvas>
        </div>
        
        <div class="chart-container">
            <h2 class="chart-title">üì¶ Recent Batch Metrics</h2>
            <div id="batchMetrics" class="predictions-list">
                <div class="loading">Loading batch metrics...</div>
            </div>
        </div>
        
        <div class="chart-container">
            <h2 class="chart-title">üîç Recent Predictions</h2>
            <div id="recentPredictions" class="predictions-list">
                <div class="loading">Loading predictions...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let autoRefresh = true;
        let refreshInterval = null;
        let charts = {};
        let currentSource = 'all';  // 'all', 'spark', 'hadoop'
        
        function switchSource(source) {
            currentSource = source;
            
            // Update button states
            document.querySelectorAll('.controls button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('btn' + source.charAt(0).toUpperCase() + source.slice(1)).classList.add('active');
            
            loadDashboard();
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        async function loadDashboard() {
            try {
                // Check API health first
                const healthResponse = await fetch(`${API_BASE}/health`);
                if (!healthResponse.ok) {
                    throw new Error('API is not available');
                }
                
                // Load all dashboard components
                await Promise.all([
                    loadStats(),
                    loadModelComparison(),
                    loadSentimentTrend(),
                    loadBatchMetrics(),
                    loadRecentPredictions()
                ]);
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Failed to load dashboard data. Please check if API is running.');
            }
        }
        
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/predictions/stats?hours=24`);
                const data = await response.json();
                
                const statsGrid = document.getElementById('statsGrid');
                
                if (!data.stats || data.stats.length === 0) {
                    statsGrid.innerHTML = '<div class="stat-card"><p>No data available yet. Start processing tweets to see statistics.</p></div>';
                    return;
                }
                
                statsGrid.innerHTML = '';
                
                data.stats.forEach(stat => {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <h3>${stat.model.replace('_', ' ').toUpperCase()}</h3>
                        <div class="stat-value">${(stat.accuracy * 100).toFixed(1)}%</div>
                        <div class="stat-detail">
                            ${stat.total.toLocaleString()} predictions<br>
                            <span style="color: #4caf50;">‚úì ${stat.correct.toLocaleString()} correct</span>
                        </div>
                    `;
                    statsGrid.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        async function loadModelComparison() {
            try {
                const response = await fetch(`${API_BASE}/models/compare?hours=24`);
                const data = await response.json();
                
                if (!data.models || data.models.length === 0) {
                    return;
                }
                
                // Filter by current source
                let filteredModels = data.models;
                if (currentSource !== 'all') {
                    filteredModels = data.models.filter(m => m.source === currentSource);
                }
                
                if (filteredModels.length === 0) {
                    return;
                }
                
                const ctx = document.getElementById('modelComparisonChart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (charts.modelComparison) {
                    charts.modelComparison.destroy();
                }
                
                // Add source label to model names
                const labels = filteredModels.map(m => `${m.model} (${m.source})`);
                
                charts.modelComparison = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Accuracy (%)',
                                data: filteredModels.map(m => (m.avg_accuracy * 100).toFixed(2)),
                                backgroundColor: 'rgba(102, 126, 234, 0.7)',
                                borderColor: 'rgba(102, 126, 234, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'F1 Score (%)',
                                data: filteredModels.map(m => (m.avg_f1_score * 100).toFixed(2)),
                                backgroundColor: 'rgba(118, 75, 162, 0.7)',
                                borderColor: 'rgba(118, 75, 162, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Percentage (%)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading model comparison:', error);
            }
        }
        
        async function loadSentimentTrend() {
            try {
                const response = await fetch(`${API_BASE}/sentiment/trend?hours=24&interval=60`);
                const data = await response.json();
                
                if (!data.trend || data.trend.length === 0) {
                    return;
                }
                
                const ctx = document.getElementById('sentimentTrendChart').getContext('2d');
                
                // Group by model
                const groupedData = {};
                data.trend.forEach(item => {
                    if (!groupedData[item.model]) {
                        groupedData[item.model] = {
                            labels: [],
                            positive: [],
                            negative: []
                        };
                    }
                    const date = new Date(item.timestamp);
                    groupedData[item.model].labels.push(date.toLocaleTimeString());
                    groupedData[item.model].positive.push(item.positive_count);
                    groupedData[item.model].negative.push(item.negative_count);
                });
                
                const firstModel = Object.keys(groupedData)[0];
                if (!firstModel) return;
                
                // Destroy existing chart if it exists
                if (charts.sentimentTrend) {
                    charts.sentimentTrend.destroy();
                }
                
                charts.sentimentTrend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: groupedData[firstModel].labels,
                        datasets: [
                            {
                                label: 'üòä Positive',
                                data: groupedData[firstModel].positive,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'üòî Negative',
                                data: groupedData[firstModel].negative,
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                tension: 0.3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Tweets'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading sentiment trend:', error);
            }
        }
        
        async function loadBatchMetrics() {
            try {
                const response = await fetch(`${API_BASE}/metrics/batch?limit=20&source=${currentSource}`);
                const data = await response.json();
                
                const container = document.getElementById('batchMetrics');
                
                if (!data.metrics || data.metrics.length === 0) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center;">No batch metrics available yet.</div>';
                    return;
                }
                
                container.innerHTML = data.metrics.map(m => {
                    const sourceLabel = m.source === 'hadoop' ? 'üêò Hadoop' : '‚ö° Spark';
                    const sourceBadgeColor = m.source === 'hadoop' ? '#FF6B35' : '#667eea';
                    
                    return `
                        <div class="prediction-item">
                            <div class="prediction-header">
                                <span class="model-badge" style="background: ${sourceBadgeColor};">
                                    ${sourceLabel} - ${m.model || 'Unknown Model'}
                                </span>
                                <span class="timestamp">${new Date(m.timestamp).toLocaleString()}</span>
                            </div>
                            <div style="margin: 10px 0;">
                                <strong>Batch ID:</strong> ${m.batch_id || 'N/A'}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px;">
                                <div>
                                    <strong>Tweets:</strong> ${(m.tweets_processed || m.total_tweets || 0).toLocaleString()}
                                </div>
                                <div>
                                    <strong>Accuracy:</strong> <span style="color: #667eea; font-weight: bold;">${((m.accuracy || 0) * 100).toFixed(2)}%</span>
                                </div>
                                <div>
                                    <strong>Precision:</strong> ${((m.precision || 0) * 100).toFixed(2)}%
                                </div>
                                <div>
                                    <strong>Recall:</strong> ${((m.recall || 0) * 100).toFixed(2)}%
                                </div>
                                <div>
                                    <strong>F1-Score:</strong> ${((m.f1_score || 0) * 100).toFixed(2)}%
                                </div>
                                <div>
                                    <strong>Time:</strong> ${(m.execution_time_seconds || m.processing_time_ms/1000 || 0).toFixed(1)}s
                                </div>
                            </div>
                            ${m.confusion_matrix ? `
                            <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                <strong>Confusion Matrix:</strong> 
                                TP: ${m.confusion_matrix.true_positive}, 
                                FP: ${m.confusion_matrix.false_positive}, 
                                TN: ${m.confusion_matrix.true_negative}, 
                                FN: ${m.confusion_matrix.false_negative}
                            </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading batch metrics:', error);
            }
        }
        
        async function loadRecentPredictions() {
            try {
                const response = await fetch(`${API_BASE}/predictions/recent?limit=20`);
                const data = await response.json();
                
                const container = document.getElementById('recentPredictions');
                
                if (!data.predictions || data.predictions.length === 0) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center;">No predictions available yet.</div>';
                    return;
                }
                
                container.innerHTML = data.predictions.map(p => {
                    const predictedLabel = p.predicted_label === 1 ? 'Positive' : 'Negative';
                    const trueLabel = p.true_label === 1 ? 'Positive' : 'Negative';
                    const isCorrect = p.predicted_label === p.true_label;
                    
                    return `
                        <div class="prediction-item">
                            <div class="prediction-header">
                                <span class="model-badge">${p.model}</span>
                                <span class="timestamp">${new Date(p.timestamp).toLocaleString()}</span>
                            </div>
                            <div style="margin: 10px 0;">
                                <strong>Tweet:</strong> ${p.text.substring(0, 150)}${p.text.length > 150 ? '...' : ''}
                            </div>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <span class="sentiment-badge ${p.predicted_label === 1 ? 'positive' : 'negative'}">
                                    Predicted: ${predictedLabel}
                                </span>
                                <span class="sentiment-badge ${p.true_label === 1 ? 'positive' : 'negative'}">
                                    Actual: ${trueLabel}
                                </span>
                                <span class="${isCorrect ? 'correct' : 'incorrect'}" style="font-weight: bold;">
                                    ${isCorrect ? '‚úì Correct' : '‚úó Incorrect'}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading recent predictions:', error);
            }
        }
        
        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            document.getElementById('autoRefreshStatus').textContent = autoRefresh ? 'ON' : 'OFF';
            
            if (autoRefresh) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        }
        
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            refreshInterval = setInterval(loadDashboard, 30000); // Refresh every 30 seconds
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        // Load dashboard on page load
        loadDashboard();
        
        // Start auto-refresh
        startAutoRefresh();
    </script>
</body>
</html>
